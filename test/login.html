<!DOCTYPE html>
<html>
<head>
	<title>Login</title>
	<meta charset="UTF-8"/>
	<style type="text/css">
		body {
			font-family: monospace;
			padding-top: 2em;
		}
		form {
			float: left;
			width: 49%;
		}
		#message_box {
			display: inline-block;
			position: absolute;
			top: 0;
			left: 51%;
			border: thin solid grey;
			background-color: lightgoldenrodyellow;
			padding: 0 5px;
		}
		#sqrl_form {
			margin-left: 2%;
		}
	</style>
	<script type="text/javascript">

		function message(msg) {
			document.getElementById("message_box").innerHTML = msg;
		}

		function authenticate(sqrlurl, sqrlsig) {
			message("Authenticating you");
			// Swap the sqrl scheme for https
			var url = sqrlurl.substring(0, 4);
			if(url == "qrl:") {
				url = "http:" + sqrlurl.substring(4);
			} else if(url == "sqrl") {
				url = "https" + sqrlurl.substring(4);
			} else {
				console.error("Invalid URL. Must start with 'sqr://' or 'sqrl://'");
				return;
			}

			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function() {
				if(xhr.readyState == 4) {
					if(xhr.status != 200) {
						console.error(xhr.status + ": " + xhr.statusText);
						message(xhr.status + ": " + xhr.statusText);
						return;
					}
					message("Authenticated");
					document.getElementById("sqrl_form").submit();
				}
			};
			xhr.open("POST", url, true);
			xhr.send("sqrlsig=" + sqrlsig);
		}

		function signUrl(url) {
			message("Signing the URL");
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function() {
				if(xhr.readyState == 4) {
					if(xhr.status != 200) {
						console.error(xhr.status + ": " + xhr.statusText);
						message(xhr.status + ": " + xhr.statusText);
						return;
					}
					// Parse the returned data
					var i = xhr.responseText.indexOf("sqrlurl=") + 8;
					var j = xhr.responseText.indexOf("&sqrlsig=");
					var sqrlurl = xhr.responseText.substring(i, j);
					var sqrlsig = xhr.responseText.substring(j + 9);
					authenticate(sqrlurl, sqrlsig);
				}
			};
			xhr.open("GET", "sign_sqrl?url=" + encodeURIComponent(url), true);
			xhr.responseType = "text";
			xhr.send();
		}

		window.addEventListener("load", function() {
			document.getElementById("sqrl_auth").onclick = function(event) {
				event.preventDefault();
				signUrl(this.href);
			}
		});
	</script>
</head>

<body>

<div id="message_box"></div>

<form id="std_form" action="do_login" method="POST">

	<label for="httpd_username">Username:</label>
	<input id="httpd_username" name="httpd_username" type="text" value="test"/>
	<br/>

	<label for="httpd_password">Password:</label>
	<input id="httpd_password" name="httpd_password" type="password" value="test"/>
	<br/>

	<input type="hidden" name="httpd_location" value="/login_success.html" />

	<button type="submit">Login</button>

</form>

<div id="form_sep"></div>

<form id="sqrl_form" action="do_login" method="POST">
	<!--#sqrl_gen url="sqrl_url" session_id="sqrl_sid" -->

	<a id="sqrl_auth" href="<!--#echo var='sqrl_url' -->"><!--#echo var="sqrl_url" --></a>
	<br/>

	<input type="hidden" name="httpd_username" value="<!--#echo var='sqrl_sid' -->"/>
	<input type="hidden" name="httpd_password" value="sqrl"/>
	<input type="hidden" name="httpd_location" value="/login_success.html" />

	<!--<button type="submit">Login</button>-->

</form>

</body>
</html>

