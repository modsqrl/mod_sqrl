<!DOCTYPE html>
<html>
<head>
	<title>Login</title>
	<meta charset="UTF-8"/>
	<style type="text/css">
		body {
			font-family: monospace;
			padding-top: 2em;
		}
		form {
			width: 49%;
			margin: 0 auto;
		}
		#message_box {
			display: inline-block;
			position: absolute;
			top: 0;
			left: 51%;
			border: thin solid grey;
			background-color: lightgoldenrodyellow;
			padding: 0 5px;
		}
		#log {
			white-space: nowrap;
		}
	</style>
	<script src="nacl_factory.js"></script>
	<script type="text/javascript">

		/**
		 * @param {string} msg Message to display.
		 */
		function message(msg) {
			document.getElementById("message_box").innerHTML = msg;
		}

		/**
		 * @param {Uint8Array} u8 Binary array to convert to base64.
		 * @returns {string} Base64 string.
		 */
		function toAscii(u8) {
			return btoa(String.fromCharCode.apply(null, u8));
		}

		/**
		 * @param {string} b64 Base64 string to decode.
		 * @returns {Uint8Array} Binary array.
		 */
		function fromAscii(b64) {
			return new Uint8Array(atob(b64).split("").map(function(c) {
			    return c.charCodeAt(0);
			}));
		}

		function authenticate(sqrlurl, sqrlkey, sqrlsig, log) {
			message("Authenticating you");
			// Swap the sqrl scheme for https
			var url = sqrlurl.substring(0, 4);
			if(url == "qrl:") {
				url = "http:" + sqrlurl.substring(4);
			} else if(url == "sqrl") {
				url = "https" + sqrlurl.substring(4);
			} else {
				console.error("Invalid URL. Must start with 'sqr://' or 'sqrl://'");
				return;
			}
			url = url.replace(/[|]/, "/");
			log.authUrl = url;

			var clientarg = "ver=1&opt=enforce&usrkey=" + sqrlkey;
			log.args = clientarg;
			clientarg = encodeURIComponent(clientarg);

			var post = "clientarg=" + clientarg + "&" +
								"serverurl=" + encodeURIComponent(sqrlurl) + "&" +
								"usrkeysig=" + sqrlsig;
			log.post = post;

			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function() {
				if(xhr.readyState == 4) {
					if(xhr.status == 200) {
						message("Authenticated");
					} else {
						console.error(xhr.status + ": " + xhr.statusText);
						message(xhr.status + ": " + xhr.statusText);
					}

					function appendDef(list, term, def) {
						list.appendChild(document.createElement("dt")).
								appendChild(document.createTextNode(term));
						list.appendChild(document.createElement("dd")).
								appendChild(document.createTextNode(def));
					}

					var dl = document.createElement("dl");
					appendDef(dl, "url", log.url);
					appendDef(dl, "scheme", log.parsedUrl.scheme);
					appendDef(dl, "domain", log.parsedUrl.domain);
					appendDef(dl, "path", log.parsedUrl.path);
					appendDef(dl, "args", log.parsedUrl.args);
					appendDef(dl, "hasMaster", log.hasMaster);
					appendDef(dl, "master", log.master);
					appendDef(dl, "private", log.private);
					appendDef(dl, "public", log.public);
					appendDef(dl, "sig", log.sig);
					appendDef(dl, "authUrl", log.authUrl);
					appendDef(dl, "args", log.args);
					appendDef(dl, "post", log.post);
					document.getElementById("log").appendChild(dl);
				}
			};
			xhr.open("POST", url, true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			xhr.send(post);
		}

		function parseUrl(url) {
			var u = {};
			var divider = url.indexOf("://");
			u.scheme = url.substring(0, divider);
			divider = divider + 3;
			var pipe = url.indexOf("|", divider);
			if(pipe > 0) {
				u.domain = url.substring(divider, pipe);
			} else {
				pipe = url.indexOf("/", divider);
				u.domain = url.substring(divider, pipe);
			}
			++pipe;
			divider = url.indexOf("?", pipe);
			u.path = url.substring(pipe, divider);
			++divider;
			u.args = url.substring(divider);
			return u;
		}

		/**
		 * @param {string} url
		 */
		function signUrl(url) {
			message("Signing the URL");
			var log = {};
			var nacl = nacl_factory.instantiate();
			var parsedUrl, privat, keyPair, sig, master64, public64, sig64;

			log.url = url;
			parsedUrl = parseUrl(url);
			log.parsedUrl = parsedUrl;

			master64 = localStorage.getItem("pk");
			if(!master64) {
				var master = new Uint8Array(32);
				for(var i = 0 ; i < 32 ; ++i) {
					master[i] = (Math.random() * 255)|0;
				}
				master64 = toAscii(master);
				localStorage.setItem("pk", master64);

				log.hasMaster = false;
				log.master = master64;
			} else {
				log.hasMaster = true;
				log.master = master64;
			}

			privat = nacl.crypto_auth(nacl.encode_utf8(parsedUrl.domain),
					fromAscii(master64));

			keyPair = nacl.crypto_sign_keypair_from_seed(privat);
			public64 = toAscii(keyPair.signPk);
			public64 = public64.replace(/[+]/g, "-").replace(/[/]/g, "_").
					replace(/[=]/g, "");
			sig = nacl.crypto_sign(nacl.encode_utf8(url), keyPair.signSk).subarray(0, 64);
			sig64 = toAscii(sig).replace(/[+]/g, "-").replace(/[/]/g, "_").
					replace(/[=]/g, "");

			log.private = toAscii(privat).replace(/[+]/g, "-").
					replace(/[/]/g, "_").replace(/[=]/g, "");
			log.public = public64;
			log.sig = sig64;

			authenticate(url, public64, sig64, log);
		}

		window.addEventListener("load", function() {
			document.getElementById("sqrl_auth").onclick = function(event) {
				event.preventDefault();
				signUrl(this.href);
			}
		});
	</script>
</head>

<body>

<div id="message_box"></div>

<form id="sqrl_form" action="do_login" method="POST">
	<!--#sqrl_gen url="sqrl_url" session_id="sqrl_sid" -->

	<a id="sqrl_auth" href="<!--#echo var='sqrl_url' -->"><!--#echo var="sqrl_url" --></a>
	<br/>

	<input type="hidden" name="httpd_username" value="<!--#echo var='sqrl_sid' -->"/>
	<input type="hidden" name="httpd_password" value="sqrl"/>
	<input type="hidden" name="httpd_location" value="/login_success.html" />

</form>

<div id="log"></div>

</body>
</html>

