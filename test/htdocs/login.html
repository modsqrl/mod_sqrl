<!DOCTYPE html>
<html>
<head>
	<title>Login</title>
	<meta charset="UTF-8"/>
	<style type="text/css">
		body {
			font-family: monospace;
			padding-top: 2em;
		}
		form {
			float: left;
			width: 49%;
		}
		#message_box {
			display: inline-block;
			position: absolute;
			top: 0;
			left: 51%;
			border: thin solid grey;
			background-color: lightgoldenrodyellow;
			padding: 0 5px;
		}
		#sqrl_form {
			margin-left: 2%;
		}
	</style>
	<script src="nacl_factory.js"></script>
	<script type="text/javascript">

		/**
		 * @param {string} msg Message to display.
		 */
		function message(msg) {
			document.getElementById("message_box").innerHTML = msg;
		}

		/**
		 * @param {Uint8Array} u8 Binary array to convert to base64.
		 * @returns {string} Base64 string.
		 */
		function toAscii(u8) {
			return btoa(String.fromCharCode.apply(null, u8));
		}

		/**
		 * @param {string} b64 Base64 string to decode.
		 * @returns {Uint8Array} Binary array.
		 */
		function fromAscii(b64) {
			return new Uint8Array(atob(b64).split("").map(function(c) {
			    return c.charCodeAt(0);
			}));
		}

		function authenticate(sqrlurl, sqrlsig) {
			message("Authenticating you");
			// Swap the sqrl scheme for https
			var url = sqrlurl.substring(0, 4);
			if(url == "qrl:") {
				url = "http:" + sqrlurl.substring(4);
			} else if(url == "sqrl") {
				url = "https" + sqrlurl.substring(4);
			} else {
				console.error("Invalid URL. Must start with 'sqr://' or 'sqrl://'");
				return;
			}

			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function() {
				if(xhr.readyState == 4) {
					if(xhr.status != 200) {
						console.error(xhr.status + ": " + xhr.statusText);
						message(xhr.status + ": " + xhr.statusText);
						return;
					}
					message("Authenticated");
					document.getElementById("sqrl_form").submit();
				}
			};
			xhr.open("POST", url, true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			xhr.send("sqrlsig=" + sqrlsig);
		}

		/**
		 * @param {string} url
		 */
		function signUrl(url) {
			message("Signing the URL");
			var nacl = nacl_factory.instantiate();
			var keyPair, sig, master64, public64, sig64;
			master64 = localStorage.getItem("pk");
			if(!master64) {
				var master = new Uint8Array(32);
				for(var i = 0 ; i < 32 ; ++i) {
					master[i] = (Math.random() * 255)|0;
				}
				master64 = toAscii(master);
				localStorage.setItem("pk", master64);
			}
			keyPair = nacl.crypto_sign_keypair_from_seed(fromAscii(master64));
			public64 = toAscii(keyPair.signPk);
			public64 = public64.replace(/[+]/g, "-").replace(/[/]/g, "_").
					replace(/[=]/g, "");
			url = url.replace(/[|]/, "/") + "&sqrlver=1&sqrlopt=enforce&sqrlkey=" +
					public64;
			sig = nacl.crypto_sign(nacl.encode_utf8(url), keyPair.signSk).subarray(0, 64);
			sig64 = toAscii(sig).replace(/[+]/g, "-").replace(/[/]/g, "_").
					replace(/[=]/g, "");
			authenticate(url, sig64);
		}

		window.addEventListener("load", function() {
			document.getElementById("sqrl_auth").onclick = function(event) {
				event.preventDefault();
				signUrl(this.href);
			}
		});
	</script>
</head>

<body>

<div id="message_box"></div>

<form id="std_form" action="do_login" method="POST">

	<label for="httpd_username">Username:</label>
	<input id="httpd_username" name="httpd_username" type="text" value="test"/>
	<br/>

	<label for="httpd_password">Password:</label>
	<input id="httpd_password" name="httpd_password" type="password" value="test"/>
	<br/>

	<input type="hidden" name="httpd_location" value="/login_success.html" />

	<button type="submit">Login</button>

</form>

<div id="form_sep"></div>

<form id="sqrl_form" action="do_login" method="POST">
	<!--#sqrl_gen url="sqrl_url" session_id="sqrl_sid" -->

	<a id="sqrl_auth" href="<!--#echo var='sqrl_url' -->"><!--#echo var="sqrl_url" --></a>
	<br/>

	<input type="hidden" name="httpd_username" value="<!--#echo var='sqrl_sid' -->"/>
	<input type="hidden" name="httpd_password" value="sqrl"/>
	<input type="hidden" name="httpd_location" value="/login_success.html" />

	<!--<button type="submit">Login</button>-->

</form>

</body>
</html>

